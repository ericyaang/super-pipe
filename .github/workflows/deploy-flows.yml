name: Prefect Deployments CI/CD
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/flows/*' # <--- Your flow from repository

jobs:
  list-flows:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - id: set-matrix
        run: echo "matrix=$(ls src/flows/*.py | jq -R -s -c 'split("\n")[:-1]')" >> $GITHUB_OUTPUT

  deploy:
    needs: list-flows
    runs-on: ubuntu-latest
    strategy:
      matrix:
        flows: ${{ fromJson(needs.list-flows.outputs.matrix) }}   
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - id: flow  # example output: "flows/hello.py:hello"
        run: |
          export FLOW_NAME=$(basename ${{ matrix.flows }} .py)
          echo "entrypoint=${{ matrix.flows }}:$FLOW_NAME" >> $GITHUB_OUTPUT
      - id: deploy
        uses: ./.github/actions/deploy-flows
        with:
          prefect_api_key: ${{ secrets.PREFECT_API_KEY }}
          prefect_api_url: ${{ secrets.PREFECT_API_URL }}
          flow_entrypoint: ${{ steps.flow.outputs.entrypoint }}
          deployment: "default" # optional
          queue: "default" # optional
          storage_block: "github/default" # optional
          infrastructure_block: "cloud-run-job/default" # optional
          python_version: "3.10" # optional
          install_command: "pip install ." # optional
        env:  # <-- Setting environment variables for the job
          GCS_S3_ENDPOINT: ${{ secrets.GCS_S3_ENDPOINT }}
          GCS_ACCESS_KEY: ${{ secrets.GCS_ACCESS_KEY }}
          GCS_SECRET: ${{ secrets.GCS_SECRET }}
          GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME }}       
          GCS_BUCKET_PATH_BRONZE: ${{ secrets.GCS_BUCKET_PATH_BRONZE }}    
          GCS_BUCKET_PATH_SILVER: ${{ secrets.GCS_BUCKET_PATH_SILVER }}    
          GCS_BUCKET_PATH_GOLD: ${{ secrets.GCS_BUCKET_PATH_GOLD }}  
          BQ_DATASET_NAME: ${{ secrets.BQ_DATASET_NAME }}     